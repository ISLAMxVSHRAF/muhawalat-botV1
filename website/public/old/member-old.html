<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø­Ø§ÙˆÙ„Ø§Øª â€” Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --orange:#F15946; --yellow:#F9C22E;
  --black:#080808; --card:rgba(20,20,20,.9); --card2:#1e1e1e;
  --border:rgba(255,255,255,.07); --text:#EEEEEE; --muted:#666;
  --green:#3ECF8E; --red:#F04747;
  --glass-bg:rgba(255,255,255,.04); --glass-border:rgba(255,255,255,.09);
  --glass-blur:blur(20px);
  --glow-o:0 0 40px rgba(241,89,70,.2); --glow-y:0 0 30px rgba(249,194,46,.15);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'IBM Plex Sans Arabic',sans-serif;background:var(--black);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* NOISE */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;}

/* AMBIENT */
.amb{position:fixed;border-radius:50%;filter:blur(130px);pointer-events:none;z-index:0;}
.amb-1{width:600px;height:600px;background:rgba(241,89,70,.07);top:-200px;right:-200px;animation:drift 15s ease-in-out infinite alternate;}
.amb-2{width:500px;height:500px;background:rgba(249,194,46,.05);bottom:5%;left:-150px;animation:drift 20s ease-in-out infinite alternate-reverse;}
@keyframes drift{from{transform:translate(0,0)}to{transform:translate(50px,60px)}}

/* â”€â”€ INVALID / LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading-screen,#invalid-screen{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:16px;background:var(--black);z-index:100;
}
.spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.08);border-top-color:var(--orange);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.load-logo{width:48px;height:48px;background:var(--orange);border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:var(--glow-o);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(241,89,70,.4)}50%{box-shadow:0 0 50px rgba(241,89,70,.7)}}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  position:sticky;top:0;
  background:rgba(8,8,8,.75);backdrop-filter:var(--glass-blur);
  border-bottom:1px solid var(--glass-border);
  padding:0 24px;height:58px;
  display:flex;align-items:center;justify-content:space-between;
  z-index:50;
}
.h-logo{display:flex;align-items:center;gap:10px;}
.h-icon{width:30px;height:30px;background:var(--orange);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;box-shadow:var(--glow-o);}
.h-name{font-size:16px;font-weight:700;letter-spacing:-.3px;}
.tab-bar{display:flex;gap:4px;}
.tab{
  padding:7px 15px;border-radius:8px;font-size:12px;font-weight:600;
  cursor:pointer;border:none;background:transparent;color:var(--muted);
  font-family:inherit;transition:all .2s;
}
.tab.active{background:var(--glass-bg);backdrop-filter:var(--glass-blur);color:var(--text);border:1px solid var(--glass-border);}
.tab:hover:not(.active){color:var(--text);}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;max-width:720px;margin:0 auto;padding:24px 16px 80px;position:relative;z-index:1;}

/* â”€â”€ PROFILE HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hero-card{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);
  border:1px solid var(--glass-border);border-radius:24px;
  padding:28px;margin-bottom:16px;position:relative;overflow:hidden;
  animation:fadeUp .5s ease both;
}
.hero-card::before{
  content:'';position:absolute;top:0;right:0;left:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);
}
.hero-card::after{
  content:'';position:absolute;top:0;right:0;left:0;height:3px;
  background:linear-gradient(90deg,var(--orange),var(--yellow));
  opacity:.8;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}

.hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;}
.hero-avatar{
  width:64px;height:64px;
  background:rgba(241,89,70,.12);
  border:1.5px solid rgba(241,89,70,.35);
  border-radius:18px;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;font-weight:700;color:var(--orange);flex-shrink:0;
  box-shadow:0 0 30px rgba(241,89,70,.2);
  animation:pulse 4s ease-in-out infinite;
}
.hero-info{flex:1;}
.hero-name{font-size:22px;font-weight:700;letter-spacing:-.5px;margin-bottom:6px;}
.rank-pill{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(249,194,46,.1);border:1px solid rgba(249,194,46,.25);
  color:var(--yellow);font-size:12px;padding:4px 12px;border-radius:100px;
  box-shadow:var(--glow-y);
}

.goal-strip{
  font-size:13px;color:var(--muted);line-height:1.7;
  border-right:3px solid var(--orange);padding-right:14px;
  margin-top:16px;
  background:rgba(241,89,70,.04);border-radius:0 8px 8px 0;
  padding:10px 14px;
}

.hero-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:20px;}
.hst{
  background:rgba(255,255,255,.04);border:1px solid var(--glass-border);
  border-radius:12px;padding:12px 10px;text-align:center;transition:all .3s;
}
.hst:hover{border-color:rgba(241,89,70,.25);box-shadow:0 4px 20px rgba(241,89,70,.1);}
.hst-num{font-size:22px;font-weight:700;color:var(--orange);}
.hst-lbl{font-size:10px;color:var(--muted);margin-top:4px;}

/* â”€â”€ SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);
  border:1px solid var(--glass-border);border-radius:18px;
  overflow:hidden;margin-bottom:14px;
  position:relative;transition:all .3s;
  animation:fadeUp .5s ease both;
}
.section::before{content:'';position:absolute;top:0;right:0;left:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);}
.section-hd{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid var(--glass-border);}
.section-title{font-size:14px;font-weight:700;}
.section-body{padding:16px 20px;}

/* â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prog-wrap{margin-bottom:4px;}
.prog-lbl{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:8px;}
.prog-track{height:7px;background:rgba(255,255,255,.06);border-radius:100px;overflow:hidden;}
.prog-fill{
  height:100%;border-radius:100px;
  background:linear-gradient(90deg,var(--orange),var(--yellow));
  transition:width 1.2s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 0 12px rgba(241,89,70,.4);
}

/* â”€â”€ HABITS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.habit-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.04);
  transition:background .15s;
}
.habit-item:last-child{border-bottom:none;}
.habit-item:hover{background:rgba(255,255,255,.02);}
.habit-check{
  width:24px;height:24px;border-radius:7px;border:1.5px solid rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;
  transition:all .3s;
}
.habit-check.done{background:var(--green);border-color:var(--green);box-shadow:0 0 12px rgba(62,207,142,.4);}
.habit-name{font-size:14px;flex:1;transition:all .3s;}
.habit-name.done{text-decoration:line-through;color:var(--muted);}

/* â”€â”€ WEEKLY CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart{display:flex;align-items:flex-end;gap:8px;height:100px;}
.chart-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;}
.chart-bar-wrap{flex:1;width:100%;display:flex;align-items:flex-end;}
.chart-bar{
  width:100%;border-radius:7px 7px 0 0;
  background:rgba(255,255,255,.05);min-height:4px;
  transition:height .9s cubic-bezier(.34,1.56,.64,1);
  position:relative;overflow:hidden;
}
.chart-bar.active{background:linear-gradient(180deg,var(--yellow),var(--orange));}
.chart-bar.active::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,rgba(255,255,255,.15),transparent);}
.chart-bar.today{background:var(--orange);box-shadow:0 0 16px rgba(241,89,70,.5);}
.chart-lbl{font-size:10px;color:var(--muted);}

/* â”€â”€ ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;}
.ach-card{
  background:rgba(255,255,255,.03);border:1px solid var(--glass-border);
  border-radius:14px;padding:16px 12px;text-align:center;transition:all .3s;
}
.ach-card.earned{
  border-color:rgba(249,194,46,.35);background:rgba(249,194,46,.06);
  box-shadow:0 0 20px rgba(249,194,46,.1);
}
.ach-card.locked{opacity:.35;filter:grayscale(.5);}
.ach-icon{font-size:26px;margin-bottom:7px;display:block;filter:drop-shadow(0 0 6px rgba(249,194,46,.3));}
.ach-name{font-size:12px;font-weight:700;margin-bottom:3px;}
.ach-desc{font-size:10px;color:var(--muted);}

/* â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lb-row{
  display:flex;align-items:center;gap:12px;
  padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;
}
.lb-row:last-child{border-bottom:none;}
.lb-row:hover{background:rgba(255,255,255,.02);}
.lb-row.me{
  background:rgba(241,89,70,.06);
  border-right:3px solid var(--orange);
  box-shadow:inset 0 0 30px rgba(241,89,70,.05);
}
.lb-rank{font-size:16px;font-weight:700;width:28px;text-align:center;}
.lb-name{flex:1;font-size:13px;font-weight:600;}
.lb-streak{font-size:11px;color:var(--muted);}
.lb-rate{font-size:18px;font-weight:700;color:var(--orange);}

/* â”€â”€ GOAL BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.goal-banner{
  background:rgba(249,194,46,.07);border:1px solid rgba(249,194,46,.2);
  border-radius:12px;padding:16px 18px;font-size:14px;line-height:1.8;
  box-shadow:var(--glow-y);
}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-page{display:none;}
.tab-page.active{display:block;animation:fadeUp .35s ease both;}

/* â”€â”€ EMPTY & LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:36px;color:var(--muted);font-size:14px;}

@media(max-width:500px){
  .hero-stats{grid-template-columns:1fr 1fr;}
  .tab-bar{overflow-x:auto;gap:2px;}
  .tab{padding:7px 11px;font-size:11px;white-space:nowrap;}
}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:rgba(241,89,70,.3);border-radius:10px;}
</style>
</head>
<body>

<div class="amb amb-1"></div>
<div class="amb amb-2"></div>

<!-- LOADING -->
<div id="loading-screen">
  <div class="load-logo">âœ³ï¸</div>
  <div class="spinner"></div>
  <div style="font-size:13px;color:var(--muted)">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ùƒ...</div>
</div>

<!-- INVALID -->
<div id="invalid-screen" style="display:none">
  <div style="font-size:52px">â°</div>
  <div style="font-size:20px;font-weight:700">Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·</div>
  <div style="font-size:13px;color:var(--muted);text-align:center;max-width:280px;line-height:1.7">Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·.<br>Ø§Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†.</div>
</div>

<!-- HEADER -->
<header>
  <div class="h-logo">
    <div class="h-icon">âœ³ï¸</div>
    <div class="h-name">Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
  </div>
  <div class="tab-bar">
    <button class="tab active" onclick="showTab('home',this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab" onclick="showTab('stats',this)">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
    <button class="tab" onclick="showTab('lb',this)">ğŸ† Ø§Ù„Ù„ÙŠØ¯Ø±Ø¨ÙˆØ±Ø¯</button>
  </div>
</header>

<!-- APP -->
<div id="app">

  <!-- HOME -->
  <div class="tab-page active" id="tab-home">
    <div class="hero-card">
      <div class="hero-top">
        <div class="hero-avatar" id="av-letter">Ù…</div>
        <div class="hero-info">
          <div class="hero-name" id="u-name">...</div>
          <div class="rank-pill" id="u-rank">ğŸŒ± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©</div>
        </div>
      </div>
      <div class="goal-strip" id="u-goal">...</div>
      <div class="hero-stats">
        <div class="hst"><div class="hst-num" id="s-streak">0</div><div class="hst-lbl">ğŸ”¥ Ø³ØªØ±ÙŠÙƒ</div></div>
        <div class="hst"><div class="hst-num" id="s-total">0</div><div class="hst-lbl">âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
        <div class="hst"><div class="hst-num" id="s-rate">0%</div><div class="hst-lbl">ğŸ“ˆ Ø§Ù„ÙŠÙˆÙ…</div></div>
        <div class="hst"><div class="hst-num" id="s-warn" style="color:var(--red)">0</div><div class="hst-lbl">âš ï¸ Ø¥Ù†Ø°Ø§Ø±Ø§Øª</div></div>
      </div>
    </div>

    <div class="section" style="animation-delay:.1s">
      <div class="section-hd">
        <div class="section-title">Ø¹Ø§Ø¯Ø§ØªÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
        <div id="h-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <div class="section-body">
        <div class="prog-wrap">
          <div class="prog-lbl"><span>Ø§Ù„ØªÙ‚Ø¯Ù…</span><span id="prog-pct">0%</span></div>
          <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
        </div>
      </div>
      <div id="habits-list"></div>
    </div>

    <div class="section" id="wg-section" style="display:none;animation-delay:.2s">
      <div class="section-hd"><div class="section-title">ğŸ¯ Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div></div>
      <div class="section-body"><div class="goal-banner" id="wg-text"></div></div>
    </div>
  </div>

  <!-- STATS -->
  <div class="tab-page" id="tab-stats">
    <div class="section">
      <div class="section-hd"><div class="section-title">ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div></div>
      <div class="section-body">
        <div class="chart" id="w-chart"><div class="empty" style="width:100%">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div></div>
      </div>
    </div>
    <div class="section">
      <div class="section-hd">
        <div class="section-title">ğŸ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
        <div id="ach-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <div class="section-body"><div class="ach-grid" id="ach-grid"></div></div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="tab-page" id="tab-lb">
    <div class="section">
      <div class="section-hd"><div class="section-title">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</div></div>
      <div id="lb-list"><div class="empty"><div class="spinner" style="margin:0 auto 8px"></div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>

</div>

<script>
const API = '';
const token = new URLSearchParams(location.search).get('token');

const RANKS = [
  {min:0,  lbl:'ğŸŒ± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©'},
  {min:7,  lbl:'âš¡ ÙŠØ¨Ù†ÙŠ Ø§Ù„Ø¹Ø§Ø¯Ø©'},
  {min:30, lbl:'ğŸ¦ Ù…Ø­ØªØ±Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'},
  {min:100,lbl:'ğŸ‘‘ Ø£Ø³Ø·ÙˆØ±Ø©'},
];
const ACHS = [
  {type:'first_day',      icon:'ğŸŒ±',name:'Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©',       desc:'Ø£ÙƒÙ…Ù„Øª Ø£ÙˆÙ„ ÙŠÙˆÙ… ÙƒØ§Ù…Ù„'},
  {type:'week_streak',    icon:'ğŸ”¥',name:'Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„',     desc:'7 Ø£ÙŠØ§Ù… Ø³ØªØ±ÙŠÙƒ'},
  {type:'month_streak',   icon:'ğŸ’',name:'Ø´Ù‡Ø± Ù…Ø«Ø§Ø¨Ø±Ø©',     desc:'30 ÙŠÙˆÙ… Ø³ØªØ±ÙŠÙƒ'},
  {type:'century_streak', icon:'ğŸ‘‘',name:'Ù…Ø¦Ø© ÙŠÙˆÙ…',        desc:'100 ÙŠÙˆÙ… Ø³ØªØ±ÙŠÙƒ'},
  {type:'century_tasks',  icon:'âš¡',name:'100 Ø¹Ø§Ø¯Ø©',       desc:'Ø£Ù†Ø¬Ø²Øª 100 Ø¹Ø§Ø¯Ø©'},
  {type:'half_k_tasks',   icon:'ğŸš€',name:'500 Ø¹Ø§Ø¯Ø©',       desc:'Ø£Ù†Ø¬Ø²Øª 500 Ø¹Ø§Ø¯Ø©'},
  {type:'thousand_tasks', icon:'ğŸ†',name:'Ø£Ù„Ù Ø¹Ø§Ø¯Ø©',       desc:'Ø£Ù†Ø¬Ø²Øª 1000 Ø¹Ø§Ø¯Ø©'},
];

addEventListener('DOMContentLoaded', async () => {
  if (!token) return showInvalid();
  await load();
});

function showInvalid() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('invalid-screen').style.display = 'flex';
}

async function load() {
  try {
    const r = await fetch(`${API}/api/member/me`, { headers: { 'x-member-token': token } });
    if (!r.ok) return showInvalid();
    const d = await r.json();

    renderProfile(d);
    renderHabits(d.habits, d.rate);
    renderChart(d.analytics.weeklyReport);
    renderAch(d.achievements);
    if (d.weeklyGoal) { document.getElementById('wg-section').style.display='block'; document.getElementById('wg-text').textContent=d.weeklyGoal; }

    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    loadLB();
  } catch { showInvalid(); }
}

function renderProfile({user, analytics, rate}) {
  const s = analytics.streakDays || 0;
  const rank = RANKS.filter(r => s >= r.min).pop().lbl;
  document.getElementById('av-letter').textContent = user.name?.[0] || 'Ù…';
  document.getElementById('u-name').textContent = user.name;
  document.getElementById('u-rank').textContent = rank;
  document.getElementById('u-goal').textContent = user.goal || user.bio || 'Ù„Ù… ØªØ­Ø¯Ø¯ Ù‡Ø¯ÙØ§Ù‹ Ø¨Ø¹Ø¯';
  document.getElementById('s-streak').textContent = s;
  document.getElementById('s-total').textContent = user.total_done || 0;
  document.getElementById('s-rate').textContent = rate + '%';
  document.getElementById('s-warn').textContent = user.warning_count || 0;
  document.title = `Ù…Ø­Ø§ÙˆÙ„Ø§Øª â€” ${user.name}`;
}

function renderHabits(habits, rate) {
  const done = habits.filter(h => h.completed).length;
  document.getElementById('h-count').textContent = `${done} / ${habits.length}`;
  document.getElementById('prog-pct').textContent = rate + '%';
  setTimeout(() => { document.getElementById('prog-fill').style.width = rate + '%'; }, 120);

  document.getElementById('habits-list').innerHTML = habits.length
    ? habits.map(h => `<div class="habit-item">
        <div class="habit-check ${h.completed?'done':''}">${h.completed?'âœ“':''}</div>
        <div class="habit-name ${h.completed?'done':''}">${h.name}</div>
      </div>`).join('')
    : '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</div>';
}

function renderChart(wr) {
  if (!wr?.length) return;
  const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  const todayIdx = new Date().getDay();
  const chart = document.getElementById('w-chart');
  chart.innerHTML = '';
  wr.forEach(d => {
    const rate = Math.round(d.rate);
    const di = new Date(d.date).getDay();
    const isToday = di === todayIdx;
    const h = Math.max(rate, 4);
    const pctColor = rate>=70?'var(--green)':rate>=40?'var(--yellow)':'var(--muted)';
    const col = document.createElement('div');
    col.className = 'chart-col';
    col.innerHTML = `<div style="font-size:10px;color:${pctColor};font-weight:700">${rate}%</div>
      <div class="chart-bar-wrap"><div class="chart-bar ${isToday?'today':'active'}" style="height:${h}%"></div></div>
      <div class="chart-lbl">${days[di].slice(0,3)}</div>`;
    chart.appendChild(col);
  });
}

function renderAch(earned) {
  const et = new Set(earned.map(a => a.type));
  document.getElementById('ach-count').textContent = `${et.size} / ${ACHS.length}`;
  document.getElementById('ach-grid').innerHTML = ACHS.map(a => `
    <div class="ach-card ${et.has(a.type)?'earned':'locked'}">
      <span class="ach-icon">${a.icon}</span>
      <div class="ach-name">${a.name}</div>
      <div class="ach-desc">${a.desc}</div>
    </div>`).join('');
}

async function loadLB() {
  try {
    const r = await fetch(`${API}/api/member/leaderboard`, { headers: { 'x-member-token': token } });
    const d = await r.json();
    const m = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    document.getElementById('lb-list').innerHTML = d.map((l,i) => `
      <div class="lb-row ${l.isMe?'me':''}">
        <div class="lb-rank">${m[i]||i+1}</div>
        <div><div class="lb-name">${l.name}${l.isMe?' <span style="color:var(--orange);font-size:10px">(Ø£Ù†Øª)</span>':''}</div><div class="lb-streak">ğŸ”¥ ${l.streak} ÙŠÙˆÙ…</div></div>
        <div class="lb-rate">${l.avgRate}%</div>
      </div>`).join('');
  } catch {}
}

function showTab(name, btn) {
  document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  btn.classList.add('active');
}
</script>
</body>
</html>
